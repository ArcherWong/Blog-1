---
layout: post
title: MySQL 递归查询
date: 2019-01-09 20:57:26
tags: [DB, MySQL, 记录]
---

# MySQL 递归查询

## 场景

最近需要将根据父级分类查询出所有的自己分类，所以却是需要使用 MySQL 实现递归查询的功能。

对于以下数据表（此处简化了）

| id  | parentId | name       |
| --- | -------- | ---------- |
| 1   | 0        | 数学       |
| 2   | 1        | 高等数学   |
| 3   | 1        | 线性代数   |
| 4   | 0        | 英语       |
| 5   | 4        | 即时翻译   |
| 6   | 4        | 口语阅读   |
| 7   | 0        | 物理       |
| 8   | 7        | 高能物理   |
| 9   | 8        | 无限能量   |
| 10  | 9        | 迪克拉之海 |

SQL 结构/数据

```sql
create table question_type (
  id       bigint primary key  not null
  comment '问题编号',
  parentId bigint              not null
  comment '问题父分类编号，根节点为 0',
  name     varchar(20)         not null
  comment '编号名称'
)
  comment '问题编号';
insert into question_type values (1, 0, '数学');
insert into question_type values (2, 1, '高等数学');
insert into question_type values (3, 1, '线性代数');
insert into question_type values (4, 0, '英语');
insert into question_type values (5, 4, '即时翻译');
insert into question_type values (6, 4, '口语阅读');
insert into question_type values (7, 0, '物理');
insert into question_type values (8, 7, '高能物理');
insert into question_type values (9, 8, '无限能量');
insert into question_type values (10, 9, '迪克拉之海');
```

吾辈只有一个 id，想要查询出所有的子级

## 解决

这个问题在网络上流传着各种各样的解决方案

- 使用额外的字段存储节点全路径
- 在应用层递归查询完成
- 使用存储过程
- 使用 SQL 视图
- 使用单条 SQL 实现

## 使用额外的字段存储节点全路径

有人提出使用一个额外的字段记录当前节点的全路径，每一级使用 `,` 进行分割，所以吾辈的数据表变成了下面这样

| id                  | parentId            | name       | path                                                                              |
| ------------------- | ------------------- | ---------- | --------------------------------------------------------------------------------- |
| 1083362227923738626 | 0                   | 数学       | 0,1083362227923738626                                                             |
| 1083362227923738627 | 1083362227923738626 | 高等数学   | 0,1083362227923738626,1083362227923738627                                         |
| 1083362227923738628 | 1083362227923738626 | 线性代数   | 0,1083362227923738626,1083362227923738628                                         |
| 1083362227923738629 | 0                   | 英语       | 0,1083362227923738629                                                             |
| 1083362227923738630 | 1083362227923738629 | 即时翻译   | 0,1083362227923738629,1083362227923738630                                         |
| 1083362227923738631 | 1083362227923738629 | 口语阅读   | 0,1083362227923738629,1083362227923738631                                         |
| 1083362227923738632 | 0                   | 物理       | 0,1083362227923738632                                                             |
| 1083362227923738633 | 1083362227923738632 | 高能物理   | 0,1083362227923738632,1083362227923738633                                         |
| 1083362227923738634 | 1083362227923738633 | 无限能量   | 0,1083362227923738632,1083362227923738633,1083362227923738634                     |
| 1083362227923738635 | 1083362227923738634 | 迪克拉之海 | 0,1083362227923738632,1083362227923738633,1083362227923738634,1083362227923738635 |

SQL 结构/数据

```sql
create table question_type (
  id       bigint primary key  not null
  comment '问题编号',
  parentId bigint              not null
  comment '问题父分类编号，根节点为 0',
  name     varchar(20)         not null
  comment '编号名称',
  path     varchar(100)        not null
  comment '全路径，每级使用 , 分割'
)
  comment '问题编号';
insert into question_type values (1083362227923738626, 0, '数学', '0,1083362227923738626');
insert into question_type
values (1083362227923738627, 1083362227923738626, '高等数学', '0,1083362227923738626,1083362227923738627');
insert into question_type
values (1083362227923738628, 1083362227923738626, '线性代数', '0,1083362227923738626,1083362227923738628');
insert into question_type values (1083362227923738629, 0, '英语', '0,1083362227923738629');
insert into question_type
values (1083362227923738630, 1083362227923738629, '即时翻译', '0,1083362227923738629,1083362227923738630');
insert into question_type
values (1083362227923738631, 1083362227923738629, '口语阅读', '0,1083362227923738629,1083362227923738631');
insert into question_type values (1083362227923738632, 0, '物理', '0,1083362227923738632');
insert into question_type
values (1083362227923738633, 1083362227923738632, '高能物理', '0,1083362227923738632,1083362227923738633');
insert into question_type values
  (1083362227923738634, 1083362227923738633, '无限能量', '0,1083362227923738632,1083362227923738633,1083362227923738634');
insert into question_type values (1083362227923738635, 1083362227923738634, '迪克拉之海',
                                  '0,1083362227923738632,1083362227923738633,1083362227923738634,1083362227923738635');
```

现在，我们可以很简单的查询了子级信息了

```sql
# 查询物理分类及其子级
select *
from question_type
where path regexp 1083362227923738632;
```

## 在应用层递归查询完成
