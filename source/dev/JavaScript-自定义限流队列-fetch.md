---
layout: post
title: JavaScript 自定义限流队列 fetch
date: 2019-01-23 13:02:57
tags: [JavaScript]
---

# JavaScript 自定义限流队列 fetch

## 为什么需要它？

有些时候不得不需要限制并发 fetch 的请求数量，避免请求过快导致 IP 封禁

## 需要做到什么？

- 允许限制 fetch 请求同时存在的数量
- 时间过久便认为是超时了

## 如何实现？

### 暂停请求

> 该方法的请求是无序的！

1. 使用 class 定义默认超时设置和请求数量限制的构造函数
2. 在请求前判断当前请求的数量，添加请求等待数量
   1. 如果请求数量已满，则进行等待
   2. 如果请求数量未满，则删除一个请求等待数量
3. 请求完成，删除当前请求数量

### 等待队列：触发钩子

1. 使用 class 定义默认超时设置和请求数量限制的构造函数
2. 在请求前将请求 argments 添加到等待队列中
3. 添加完成，尝试启动等待队列（钩子）
   - 如果数量过多，就不做任何事情
   - 如果数量没有超出最大限制，那就循环执行请求，直到到达最大限制
4. 请求完成，尝试启动等待队列（钩子）

### 等待队列：循环监听

1. 使用 class 定义默认超时设置和请求数量限制的构造函数
2. 在请求前将请求 argments 添加到等待队列中
3. 使用 `setInterval` 函数持续监听队列和当前执行的请求数
   - 发现请求数量没有到达最大值，且等待队列中还有值，那么就执行一次请求

## 实现代码
